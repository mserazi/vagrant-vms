# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|
  # Common configuration
  config.vm.box = "bento/ubuntu-24.04"

  # Development Server VM
  config.vm.define "dev-server" do |dev|
    dev.vm.hostname = "ubuntu-dev-server"
    dev.vm.network "private_network", ip: "192.168.56.10"
    dev.vm.network "public_network", bridge: true
    
    dev.vm.provider "virtualbox" do |vb|
      vb.name = "ubuntu-dev-server"
      vb.memory = "2048"
      vb.cpus = 2
    end
    
    dev.vm.provision "shell", inline: <<-SHELL
      #set -e
      apt update
      apt install -y build-essential pkg-config \
                     python3 python3-pip python3-venv python-is-python3 \
                     curl openssl cmake git autoconf libtool libgflags-dev libgtest-dev clang libc++-dev \
                     libgrpc++-dev protobuf-compiler-grpc protobuf-compiler libabsl-dev libpqxx-dev libprotobuf-dev

      # Add host entries for VM communication
      echo "192.168.56.10 ubuntu-dev-server dev-server" >> /etc/hosts
      echo "192.168.56.11 postgres-server pg-server" >> /etc/hosts

      #download latest version of abseil, compile and install
      # cd /tmp && git clone https://github.com/abseil/abseil-cpp.git
      # cd /tmp/abseil-cpp && git tag | grep -E "2023|2024" | tail -5   
      # cd /tmp/abseil-cpp && git checkout 20240722.0
      # cd /tmp/abseil-cpp && mkdir build && cd build && cmake -DCMAKE_INSTALL_PREFIX=$HOME/.local -DCMAKE_BUILD_TYPE=Release -DABSL_BUILD_TESTING=OFF -DABSL_USE_EXTERNAL_GOOGLETEST=ON ..
      # cd /tmp/abseil-cpp/build && make install
      
    SHELL
  end

  # PostgreSQL Database Server VM
  config.vm.define "postgres-server" do |pg|
    pg.vm.hostname = "postgres-server"
    pg.vm.network "private_network", ip: "192.168.56.11"
    pg.vm.network "public_network", bridge: true
    
    pg.vm.provider "virtualbox" do |vb|
      vb.name = "postgres-server"
      vb.memory = "2048"
      vb.cpus = 1
    end
    
    pg.vm.provision "shell", inline: <<-SHELL
      #set -e
      apt update
      apt install -y postgresql postgresql-contrib postgresql-client
      
      # Add host entries for VM communication
      echo "192.168.56.10 ubuntu-dev-server dev-server" >> /etc/hosts
      echo "192.168.56.11 postgres-server pg-server" >> /etc/hosts
      
      # Configure PostgreSQL
      sudo -u postgres psql -c "ALTER USER postgres PASSWORD 'postgres';"
      
      # Allow remote connections
      echo "listen_addresses = '*'" >> /etc/postgresql/16/main/postgresql.conf
      echo "host all all 192.168.56.0/24 md5" >> /etc/postgresql/16/main/pg_hba.conf
      
      # Restart PostgreSQL
      systemctl restart postgresql
      systemctl enable postgresql
      
      # Create a sample database
      sudo -u postgres createdb devdb
      
      echo "PostgreSQL installation completed!"
      echo "Database server IP: 192.168.56.11"
      echo "Default username: postgres"
      echo "Default password: postgres"
      echo "Sample database: devdb"
    SHELL
  end
end
